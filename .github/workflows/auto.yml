name: Android Firmware Extraction and DT Generation

on:
  workflow_dispatch:
    inputs:
      LINK_GDRIVE:
        description: 'Google Drive link to firmware file'
        required: true
        type: string
      OUTPUT_DIR:
        description: 'Output directory name (optional)'
        required: false
        default: 'device_tree'
        type: string
      NO_PROPRIETARY:
        description: 'Skip proprietary files extraction'
        required: false
        default: false
        type: boolean

jobs:
  extract-and-generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            erofs-utils \
            android-sdk-libsparse-utils \
            p7zip-full \
            liblz4-tool \
            brotli \
            curl

      - name: Download and setup lpunpack.py
        run: |
          curl -L https://raw.githubusercontent.com/unix3dgforce/lpunpack/refs/heads/master/lpunpack.py -o /tmp/lpunpack.py
          chmod +x /tmp/lpunpack.py
          sudo ln -sf /tmp/lpunpack.py /usr/local/bin/lpunpack
          # Test
          python3 /tmp/lpunpack.py --help | head -3 || true

      - name: Install Python packages
        run: |
          pip install aospdtgen dumpyara gdown

      - name: Extract File ID and Setup Service Account
        id: setup
        run: |
          GDRIVE_LINK="${{ github.event.inputs.LINK_GDRIVE }}"
          
          # Extract File ID
          if [[ $GDRIVE_LINK =~ /file/d/([a-zA-Z0-9_-]+) ]]; then
            FILE_ID="${BASH_REMATCH[1]}"
          elif [[ $GDRIVE_LINK =~ id=([a-zA-Z0-9_-]+) ]]; then
            FILE_ID="${BASH_REMATCH[1]}"
          elif [[ $GDRIVE_LINK =~ /d/([a-zA-Z0-9_-]+) ]]; then
            FILE_ID="${BASH_REMATCH[1]}"
          else
            echo "Error: Could not extract file ID from link"
            exit 1
          fi
          
          echo "FILE_ID=$FILE_ID" >> $GITHUB_ENV
          echo "File ID: $FILE_ID"
          
          # Setup Service Account
          echo '${{ secrets.GDRIVE_SERVICE_ACCOUNT }}' | base64 -d > /tmp/service_account.json
          
          if [ ! -s /tmp/service_account.json ]; then
            echo "Error: Service account empty or not configured"
            exit 1
          fi
          
          echo "Service account configured"

      - name: Install gdrive
        run: |
          wget -q https://github.com/gdrive-org/gdrive/releases/download/2.1.1/gdrive-linux-x64 -O /tmp/gdrive
          chmod +x /tmp/gdrive
          sudo mv /tmp/gdrive /usr/local/bin/

      - name: Setup gdrive with Service Account
        run: |
          echo '${{ secrets.GDRIVE_SERVICE_ACCOUNT }}' | base64 -d > /tmp/sa.json
          # gdrive menggunakan environment variable
          export GOOGLE_SERVICE_ACCOUNT=/tmp/sa.json

      - name: Download with gdrive
        run: |
          gdrive download "${{ env.FILE_ID }}" --stdout > firmware.zip

      - name: Extract firmware with dumpyara
        run: |
          python3 -m dumpyara "${{ env.FILENAME }}" -o extracted_firmware -v

      - name: Generate device tree with aospdtgen
        run: |
          OUTPUT="${{ github.event.inputs.OUTPUT_DIR }}"
          
          if [ "${{ github.event.inputs.NO_PROPRIETARY }}" == "true" ]; then
            python -m aospdtgen --no-proprietary-files -o "$OUTPUT" extracted_firmware/
          else
            python -m aospdtgen -o "$OUTPUT" extracted_firmware/
          fi

      - name: Upload device tree artifact
        uses: actions/upload-artifact@v4
        with:
          name: device-tree-${{ github.run_number }}
          path: ${{ github.event.inputs.OUTPUT_DIR }}/
          retention-days: 3

      - name: Cleanup
        if: always()
        run: |
          rm -f firmware.zip 2>/dev/null || true
          rm -rf extracted_firmware 2>/dev/null || true
          rm -f /tmp/lpunpack.py /tmp/service_account.json 2>/dev/null || true
