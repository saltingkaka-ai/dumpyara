name: Android Firmware Extraction (Pixeldrain Only)

on:
  workflow_dispatch:
    inputs:
      PIXELDRAIN_ID:
        description: 'Pixeldrain file ID (contoh: AbCdEfGh dari https://pixeldrain.com/u/AbCdEfGh)'
        required: true
        type: string
      OUTPUT_DIR:
        description: 'Output directory name (optional)'
        required: false
        default: 'device_tree'
        type: string
      NO_PROPRIETARY:
        description: 'Skip proprietary files extraction'
        required: false
        default: false
        type: boolean

jobs:
  extract-and-generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            erofs-utils \
            android-sdk-libsparse-utils \
            p7zip-full \
            liblz4-tool \
            brotli \
            curl \
            unzip

      - name: Download and setup lpunpack.py
        run: |
          curl -L https://raw.githubusercontent.com/unix3dgforce/lpunpack/refs/heads/master/lpunpack.py -o /tmp/lpunpack.py
          chmod +x /tmp/lpunpack.py
          sudo ln -sf /tmp/lpunpack.py /usr/local/bin/lpunpack

      - name: Install Python packages
        run: |
          pip install aospdtgen dumpyara

      - name: Download firmware from Pixeldrain
        id: download
        run: |
          PD_ID="${{ github.event.inputs.PIXELDRAIN_ID }}"
          
          echo "Downloading from Pixeldrain: $PD_ID"
          echo "URL: https://pixeldrain.com/u/$PD_ID"
          
          # Download dengan progress dan retry
          curl -fSL \
            --retry 5 \
            --retry-delay 10 \
            --retry-max-time 300 \
            --connect-timeout 30 \
            --max-time 0 \
            --progress-bar \
            "https://pixeldrain.com/api/file/${PD_ID}" \
            -o firmware.zip
          
          # Verifikasi ukuran
          SIZE=$(stat -c%s firmware.zip)
          echo ""
          echo "Downloaded: $SIZE bytes ($(numfmt --to=iec-i $SIZE))"
          
          # Minimal 100MB untuk firmware valid
          if [ "$SIZE" -lt 100000000 ]; then
              echo "ERROR: File too small, likely not a firmware ($SIZE bytes)"
              echo "Content preview:"
              head -c 500 firmware.zip | strings || true
              exit 1
          fi
          
          # Cek bukan HTML error
          if head -c 200 firmware.zip | strings | grep -qiE "<html|error|not.found"; then
              echo "ERROR: Downloaded HTML error page"
              head -c 1000 firmware.zip | strings | head -10
              exit 1
          fi
          
          echo "FILENAME=firmware.zip" >> $GITHUB_ENV
          echo "✓ Firmware download successful!"

      - name: Extract firmware with dumpyara
        run: |
          echo "Extracting firmware..."
          python3 -m dumpyara "${{ env.FILENAME }}" -o extracted_firmware -v

      - name: Generate device tree with aospdtgen
        run: |
          OUTPUT="${{ github.event.inputs.OUTPUT_DIR }}"
          
          echo "Generating device tree..."
          if [ "${{ github.event.inputs.NO_PROPRIETARY }}" == "true" ]; then
            python -m aospdtgen --no-proprietary-files -o "$OUTPUT" extracted_firmware/
          else
            python -m aospdtgen -o "$OUTPUT" extracted_firmware/
          fi

      - name: Upload device tree artifact
        uses: actions/upload-artifact@v4
        with:
          name: device-tree-${{ github.run_number }}
          path: ${{ github.event.inputs.OUTPUT_DIR }}/
          retention-days: 3

      - name: Show results
        if: success()
        run: |
          echo "========================================"
          echo "✓ SUCCESS!"
          echo "Device tree generated in: ${{ github.event.inputs.OUTPUT_DIR }}/"
          echo "Download artifact from: Actions → This run → Artifacts"
          echo "========================================"

      - name: Cleanup
        if: always()
        run: |
          rm -f firmware.zip 2>/dev/null || true
          rm -rf extracted_firmware 2>/dev/null || true
          rm -f /tmp/lpunpack.py 2>/dev/null || true
